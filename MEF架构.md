---
typora-copy-images-to: pics
typora-root-url: pics
---

# MEF框架

### 一、MEF是什么

提出问题：

在开发大型应用程序，特别是客户端程序，我们会把各个独立的模块/功能包装成一个小小的组件，程序运行时按需加载。这样，我们要求程序具有很好的扩展能力，包括下面几个方面：

- 按需加载组件，动态可拆卸（可动态发现、重用和组合）
- 能工在已投产品的产品中灵活的加入新功能
- 能够支持第三方扩展

解决问题：

为了解决扩展问题，我们都会在框架中设置一些扩展点（或者接口），用于组件（扩展者）的扩展。程序运行时按需（或者按配置）讲这些扩展点和扩展者加载并关联。

目前能够满足需求的框架很多，例如：Castle，Unity等。castle通过在配置文件中显示注册可用组件来实现，配置文件的劣势在于配置出错后需要很长的时间来解决问题。

MEF：

MEF，Managed Extensibility Framwork 托管可扩展框架。MSDN对MEF的说明

> Managed Extensibility Framework 或 MEF 是一个用于创建可扩展的轻型应用程序的库。 应用程序开发人员可利用该库发现并使用扩展，而无需进行配置。 扩展开发人员还可以利用该库轻松地封装代码，避免生成脆弱的硬依赖项。 通过 MEF，不仅可以在应用程序内重用扩展，还可以在应用程序之间重用扩展。

通过上面两段MSDN中的说明，我个人对为什么选择MEF总结如下：

- 它解决了扩展性的问题（这是第一位的，不然我们就没必要介绍MEF了）；
- 它轻量级，使用时只需要引用一个dll库；
- 扩展性不是通过配置文件实现，而是使用特性化编程模型；
- 该框架是开源的，可在[codeplex](http://mef.codeplex.com/)上下载源码；
- 它是微软开发的（这一点很重要）。

> “MEF 是 .NET Framework 4 的组成部分，可用在任何使用 .NET Framework 的地方。 可以在客户端应用程序中使用 MEF（无论应用程序使用的是 Windows 窗体、WPF，还是任何其他技术），也可以在使用 ASP.NET 的服务器应用程序中使用 MEF”

### 二、MEF工作原理

MEF不同于显示注册组件的方法。在MEF中组件被视为部件。这些部件主要有“导入”Import部件和“导出”Export部件，此外，MEF提供了一个组合容器（ComposeContainer），容器会发现指定Catalog的导入导出部件，并按Contract协定、Metadata元数据等，对导入和导出部件进行组合。

> 通过 MEF，应用程序可以通过部件的元数据来发现并检查部件，而不用实例化部件，或者甚至不用加载部件的程序集。 因此，没有必要仔细指定应何时以及如何加载扩展。 使用 MEF 编写的可扩展应用程序会声明一个可由扩展组件填充的导入，而且还可能会声明导出，以便向扩展公开应用程序服务。 每个扩展组件都会声明一个导出，而且还可能会声明导入。 通过这种方式，扩展组件本身是自动可扩展的。

上述文字已经把MEF中涉及的相关概念指出了，下面具体说明一下：

- Export（导出）： “Export”也就是我们常说的组件或者模块或者服务，它是部件向容器中的其他部件提供的一个值、功能或服务等;
- Import（导入）： "Import”,既扩展点，是组件，服务等接入系统的窗口，是部件向要通过可用导出满足的容器提出的要求，MEF 支持若干导入类型，其中包括动态导入、延迟导入、必备导入和可选导入；
- Contract（协定）：是Export和Import的一种约定，一种协议，只有Contract相匹配的Import和Export部件才能组装成功；
- Catalog（目录）：为了发现可用于组合容器的部件，组合容器将使用“Catalog”。 目录是一个对象，通过它发现可用部件， MEF 提供了用于从提供的类型、程序集或磁盘路径创建Catalog。
- Compose（组合）：在MEF中，容器将导入与导出匹配的这一过程我们称之为组合，部件由 MEF 组合，MEF 将部件实例化，然后使导出程序与导入程序相匹配。

